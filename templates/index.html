{% extends "base.html" %}
{% block content %}
<section class="py-4">
  <div class="p-5 mb-4 bg-light rounded-3">
    <div class="container-fluid py-5">
      <h1 class="display-6 fw-bold">Beauty that loves you back.</h1>
      <p class="col-md-8 fs-5">Clean, vibrant, and designed for every skin tone â€” discover the Christine range.</p>
      <a href="{{ url_for('products') }}" class="btn btn-primary btn-lg">Shop Products</a>
    </div>
  </div>
</section>

{% if featured %}
<section class="mb-5">
  <h2 class="h4 mb-3">Featured</h2>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
    {% for p in featured %}
      <div class="col">
        <div class="card h-100">
          <img src="{{ p.image_url or url_for('static', filename='img/placeholder.svg') }}" class="card-img-top" alt="{{ p.name }}">
          <div class="card-body">
            <h3 class="h6 card-title"><a class="text-decoration-none" href="{{ url_for('product_detail', slug_or_id=p.slug) }}">{{ p.name }}</a></h3>
            <p class="mb-1">
              {% if p.sale_price and p.sale_price < p.price %}
                <span class="text-muted text-decoration-line-through">{{ p.price|money }}</span>
                <span class="fw-bold text-danger">{{ p.sale_price|money }}</span>
              {% else %}
                <span class="fw-bold">{{ p.price|money }}</span>
              {% endif %}
            </p>
            <div class="small text-muted">
              {{ p.brand }} â€¢ {{ p.category }}
              {% if p.stock and p.stock > 0 %}
                <span class="badge bg-success ms-2">{{ p.stock }} in stock</span>
              {% else %}
                <span class="badge bg-secondary ms-2">Out of stock</span>
              {% endif %}
            </div>
            
            {% if auth_user and p.stock and p.stock > 0 %}
              <form action="{{ url_for('cart_add', slug_or_id=p.slug) }}" method="post" class="mt-2">
                <button type="submit" class="btn btn-sm btn-outline-primary w-100">Add to Cart</button>
              </form>
            {% elif not auth_user %}
              <div class="mt-2 small text-muted">Log in to add to cart</div>
            {% endif %}
            
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<section>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0">Latest arrivals</h2>
    <div>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('products') }}">Browse all</a>
    </div>
  </div>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
    {% for p in latest %}
      <div class="col">
        <div class="card h-100">
          <img src="{{ p.image_url or url_for('static', filename='img/placeholder.svg') }}" class="card-img-top" alt="{{ p.name }}">
          <div class="card-body">
            <h3 class="h6 card-title"><a class="text-decoration-none" href="{{ url_for('product_detail', slug_or_id=p.slug) }}">{{ p.name }}</a></h3>
            <p class="mb-1">
              {% if p.sale_price and p.sale_price < p.price %}
                <span class="text-muted text-decoration-line-through">{{ p.price|money }}</span>
                <span class="fw-bold text-danger">{{ p.sale_price|money }}</span>
              {% else %}
                <span class="fw-bold">{{ p.price|money }}</span>
              {% endif %}
            </p>
            <div class="small text-muted">
              {{ p.brand }} â€¢ {{ p.category }}
              {% if p.stock and p.stock > 0 %}
                <span class="badge bg-success ms-2">{{ p.stock }} in stock</span>
              {% else %}
                <span class="badge bg-secondary ms-2">Out of stock</span>
              {% endif %}
            </div>
            
            {% if auth_user and p.stock and p.stock > 0 %}
              <form action="{{ url_for('cart_add', slug_or_id=p.slug) }}" method="post" class="mt-2">
                <button type="submit" class="btn btn-sm btn-outline-primary w-100">Add to Cart</button>
              </form>
            {% elif not auth_user %}
              <div class="mt-2 small text-muted">Log in to add to cart</div>
            {% endif %}
            
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section id="contact" class="mt-5">
  <div class="row g-4">
    <div class="col-md-6">
      <h2 class="h4">Contact us</h2>
      <form method="post" action="{{ url_for('contact_submit') }}" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input class="form-control" name="name" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" name="email" required>
        </div>
        <div class="col-12">
          <label class="form-label">Message</label>
          <textarea class="form-control" name="message" rows="4" required></textarea>
        </div>
        <div class="col-12">
          <button class="btn btn-primary">Send</button>
        </div>
      </form>
    </div>
    <div class="col-md-6">
      <h2 class="h4">About Christine</h2>
      <p>We make high-performance cosmetics with skin-loving ingredients. Our formulations are tested for comfort, shade range, and lasting wear.</p>
      <ul class="list-unstyled small">
        <li>â€¢ Nairobi, Kenya</li>
        <li>â€¢ Open Monâ€“Sat, 9amâ€“6pm</li>
        <li>â€¢ Email: hello@christinecosmetics.com</li>
      </ul>
    </div>
  </div>
</section>

{% if not auth_user %}
<!-- Auth prompt (bottom popup) -->
<div id="auth-pop" class="auth-pop shadow-lg" role="dialog" aria-live="polite" aria-label="Sign in or Sign up">
  <div class="d-flex align-items-start">
    <div class="flex-grow-1 me-3">
      <strong>Welcome! ðŸ‘‹</strong>
      <div class="small text-muted">Create an account or log in to save your details and pay faster with M-Pesa.</div>
    </div>
    <button class="btn-close" aria-label="Close"></button>
  </div>
  <div class="mt-3 d-flex gap-2">
    <a href="{{ url_for('signup') }}" class="btn btn-primary btn-sm">Sign up</a>
    <a href="{{ url_for('login') }}" class="btn btn-outline-secondary btn-sm">Log in</a>
  </div>
</div>

<style>
  .auth-pop{
    position:fixed; left:1rem; right:1rem; bottom:1rem;
    background:#fff; border-radius:.75rem; padding:1rem;
    display:none; z-index:1080; border:1px solid rgba(0,0,0,.08);
  }
  @media (min-width: 768px){ .auth-pop{ left:auto; width:420px; } }
  .auth-pop.show{ display:block; animation:slideUp .25s ease-out; }
  @keyframes slideUp{ from{ transform:translateY(12px); opacity:0;}
                      to{ transform:translateY(0); opacity:1;} }
</style>

<script>
(() => {
  const KEY = 'gb_auth_prompt_dismissed_v1';
  const POP_ID = 'auth-pop';
  const SHOW_DELAY_MS = 2500; // show after 2.5s

  function dismiss(el){
    try { sessionStorage.setItem(KEY, '1'); } catch(e){}
    el?.remove();
  }

  function show(){
    const el = document.getElementById(POP_ID);
    if(!el) return;
    el.classList.add('show');
    el.querySelector('.btn-close')?.addEventListener('click', () => dismiss(el));
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') dismiss(el);
    });
  }

  // Only show once per tab session
  const dismissed = (() => { try { return sessionStorage.getItem(KEY); } catch(e){ return '1'; } })();
  if (!dismissed) {
    window.addEventListener('load', () => setTimeout(show, SHOW_DELAY_MS));
  }
})();
</script>
{% endif %}

{% endblock %}
