{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-4">Checkout</h1>

<form method="post" id="checkoutForm">
  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">County</label>
      <select name="county" id="county" class="form-select" required>
        <option value="">Select County</option>
        <option>Baringo</option>
        <option>Bomet</option>
        <option>Bungoma</option>
        <option>Busia</option>
        <option>Elgeyo-Marakwet</option>
        <option>Embu</option>
        <option>Garissa</option>
        <option>Homa Bay</option>
        <option>Isiolo</option>
        <option>Kajiado</option>
        <option>Kakamega</option>
        <option>Kericho</option>
        <option>Kiambu</option>
        <option>Kilifi</option>
        <option>Kirinyaga</option>
        <option>Kisii</option>
        <option>Kisumu</option>
        <option>Kitui</option>
        <option>Kwale</option>
        <option>Laikipia</option>
        <option>Lamu</option>
        <option>Machakos</option>
        <option>Makueni</option>
        <option>Mandera</option>
        <option>Marsabit</option>
        <option>Meru</option>
        <option>Migori</option>
        <option>Mombasa</option>
        <option>Murang'a</option>
        <option>Nairobi</option>
        <option>Nakuru</option>
        <option>Nandi</option>
        <option>Narok</option>
        <option>Nyamira</option>
        <option>Nyandarua</option>
        <option>Nyeri</option>
        <option>Samburu</option>
        <option>Siaya</option>
        <option>Taita-Taveta</option>
        <option>Tana River</option>
        <option>Tharaka-Nithi</option>
        <option>Trans Nzoia</option>
        <option>Turkana</option>
        <option>Uasin Gishu</option>
        <option>Vihiga</option>
        <option>Wajir</option>
        <option>West Pokot</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Town</label>
      <select name="town" id="town" class="form-select" required>
        <option value="">Select Town</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Street / Address</label>
      <input type="text" class="form-control" name="address" required>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Phone Number</label>
    <input type="text" id="phone" class="form-control" name="phone"
           value="{{ user_phone or '' }}" placeholder="07XXXXXXXX" required>
  </div>

  <h2 class="h5">Order Summary</h2>
  <ul class="list-group mb-3">
    {% for i in items %}
      <li class="list-group-item d-flex justify-content-between">
        {{ i.product.name }} √ó {{ i.quantity }}
        <span>{{ (i.quantity * (i.product.sale_price or i.product.price))|money }}</span>
      </li>
    {% endfor %}
    <li class="list-group-item d-flex justify-content-between fw-bold">
      Total <span>{{ total|money }}</span>
    </li>
  </ul>

  <button type="submit" class="btn btn-success btn-lg w-100">Pay with M-Pesa</button>

  <div id="mpesaMessage" class="mt-3 small"></div>
</form>

<script>
// ‚úÖ County ‚Üí Town mapping (extend as needed)
const townsByCounty = {
  "Nairobi": ["Westlands", "Kilimani", "Eastleigh", "CBD", "Embakasi"],
  "Kisumu": ["Milimani", "Kondele", "Nyalenda", "Nyamasaria"],
  "Mombasa": ["Nyali", "Likoni", "Kisauni", "Changamwe"],
  "Nakuru": ["Naivasha", "Gilgil", "Njoro"],
  "Kiambu": ["Thika", "Ruiru", "Limuru", "Kiambu Town"],
  "Kakamega": ["Kakamega Town", "Mumias", "Lugari"],
  "Kericho": ["Kericho Town", "Litein", "Kapkatet"],
  "Uasin Gishu": ["Eldoret", "Turbo", "Moiben"]
};

const countySel = document.getElementById("county");
const townSel = document.getElementById("town");

countySel.addEventListener("change", () => {
  const towns = townsByCounty[countySel.value] || [];
  townSel.innerHTML = '<option value="">Select Town</option>';
  towns.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t; opt.textContent = t;
    townSel.appendChild(opt);
  });
});

// ‚úÖ STK Push Logic
document.getElementById("payMpesa")?.addEventListener("click", async () => {
  const phone = document.getElementById("phone").value.trim();
  const msgEl = document.getElementById("mpesaMessage");

  if (!/^((?:2547\d{8})|(07\d{8}))$/.test(phone)) {
    msgEl.innerHTML = `<span class="text-danger">Enter a valid Safaricom number (07XXXXXXXX or 2547XXXXXXXX).</span>`;
    return;
  }

  msgEl.innerHTML = "üì≤ Sending STK Push, check your phone...";

  try {
    const res = await fetch("{{ url_for('mpesa.stk_push') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone_number: phone,
        amount: "{{ total }}",
        account_ref: "checkout_{{ g.user._id }}"
      })
    });

    const data = await res.json();
    if (res.ok && data.ok !== false) {
      msgEl.innerHTML = `<span class="text-success">‚úÖ STK Push sent! Enter PIN on your phone to complete payment.</span>`;
      document.getElementById("checkoutForm").submit(); // submit order after push
    } else {
      msgEl.innerHTML = `<span class="text-danger">‚ùå Payment failed: ${data.error || "Unknown error"}</span>`;
    }
  } catch (err) {
    msgEl.innerHTML = `<span class="text-danger">‚ö†Ô∏è Error: ${err.message}</span>`;
  }
});
</script>
{% endblock %}
